{"componentChunkName":"component---node-modules-sudaraka-94-gatsby-theme-novela-src-templates-article-template-tsx-content-file-path-content-posts-2024-12-22-high-cardinality-tags-in-metrics-index-mdx","path":"/tackling-high-cardinality-tags-in-metrics/","result":{"pageContext":{"stale":false,"article":{"id":"955710d7-6ce2-5155-98dc-2afb76a71416","slug":"/tackling-high-cardinality-tags-in-metrics","secret":false,"title":"Tackling High Cardinality Tags in Metrics","author":"Sudaraka Jayathilaka","date":"December 22nd, 2024","dateForSEO":"2024-12-22T00:00:00.000Z","timeToRead":"4 min read","excerpt":"I wanted to share how I tackled the problem of high cardinality tags in a certain metric. But first, let me give some context around the…","canonical_url":null,"subscription":true,"content_file_path":"/home/runner/work/sudaraka94.github.io/sudaraka94.github.io/content/posts/2024-12-22-high-cardinality-tags-in-metrics/index.mdx","body":"\nI wanted to share how I tackled the problem of high cardinality tags in a certain metric. But first, let me give some context around the topic of Metrics and Metric tags.\n\n## Metrics\nMetrics are a vital part of any software system. You can find many mature Specifications in different technology domains standardizing the usage of metrics. [Microprofile Metrics Specification](https://microprofile.io/specifications/metrics), \nis one of my favourites. But introducing a metric to a system isn't always a straightforward decision, We always need to figure out what works best for the use case. This comes down to the questions such as,\nIs it A counter? A gauge? or some other type of metric?\nWhat are the metadata we want to include as tags in the metric?\nHow is it going to be visualized? \nWill there be any monitors set up on the metric?\n\n## Metric Tags\nOne of the main aspects of a metric is tags. Metric tags give us a lot of agility in visualizing and analyzing certain metrics. Let's take a hypothetical example.\nYou have an API service that allows users to make event ticket purchases. Now you want to monitor the purchases happening through the API and track the aspects such as,\nNumber of purchases by each account per minute \nCountry of origin for each purchase\nWhether each purchase was successful or failed\nServer id, which served the specific purchase\n\nTo obtain these types of insights, we can simply tag the metric with the relevant information.\nTag the metric with, `country: us` to group purchase metrics with the country.\nTag the metric with, `success: true` or `success: false` depending on the status of the call. This might help track the failure rate of the calls made to the API.\n\n## Collecting and Visualizing Metrics\nFor collecting and visualizing metrics, you have two options\nYou can use a self-hosted solution like Prometheus.\nYou can use a platform like DataDog/NewRelic.\nI don't want to bore you with the details about the pros and cons of both. But the problem I'm talking about is mostly related to the second option.\n\nWhen using third-party services like DataDog, they do have a pricing strategy that accounts for the cardinality of the tags added for the metrics. For example, [this Datadog documentation](https://docs.datadoghq.com/account_management/billing/custom_metrics/?tab=countrate#when-are-you-charged-for-ingested-vs-indexed-custom-metrics) explains \nhow tags and the cardinality of tags cause a single metric to be reported as multiple custom metrics in DataDog.\n\nTLDR; When you have metrics with exponentially high cardinality, you have to pay so much more.\n\n## How Can we tackle this problem efficiently?\nLet's take the previous hypothetical scenario. I gave a few examples of tags we can add to the metric. One of them was adding the accountId (or any other account identifier) to the metric for tracking the rate of purchases in the scope of an account. But unlike adding the country as a tag (there is only a finite amount of countries in the world), adding the accountId can be super expensive due to the sheer number of accounts that can be created within the system. Cost isn't the only problem here. Having a tag with so many values might not provide really meaningful insights as well. \nOne of the solutions is to use a histogram metric for tracking the rate of purchases. The histogram aggregates the reported values into different buckets. Consider following values\n- Account A -> 1 purchases per minute\n- Account B -> 1000 purchases per minute\n- Account C -> 1001 purchases per minute\n\nInstead of tagging the metric with the accountId, the distribution of purchases per minute can be divided into buckets by the number of purchases made within the time window. According to the example,\n- `0 <= n < 100`: [Account A]\n- `1000 <= n < 1100`: [Account B, Account C]\n\nThis way, we can essentially eliminate the high cardinality tags and obtain meaningful insights from the metrics such as,\nHow many accounts are there with above 1000 purchases per minute?\nIf we were to rate limit the API for too many purchase requests, what would be the limit value? \n## Conclusion\nIt's always critical to think about the cost when adding metrics. High cardinality tags can be the cause of unexpectedly high invoices from observability vendors like NewRelic and Datadog. If this is happening, it's always worth backtracking from what you really want to measure to what kind of metric you need to use.\n","hero":{"full":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAACl0lEQVR42lWSy27TQBSGHdSglkVpmwSoKqigQCugErQseAJgUbEERJ+j4jkqVgheoBKr0nWRuKoiwXV8Gd/i2IntseNL7Li248RuOVHFgn9xNNLom//M+Q/h+/08z4uiSNM0juMkGUKNoigMQ9/3Xde1bLtn2WSL/YZ+a5qmttuiJDU4EsmIgKsgCIqJ8tFonKb/wY7j2JZlGZiU2UPm5xHbUFotTkCcyCqKTPieF/Qn5qAsy879B4MBvOh5nttzbBPbukkJNMkfN7gGjRiWZyVJlESRAMezszOo43wMcJIkJ6DoJAxCIE2s823xCDWO+WNOYASerVN1mqMFXqCbTSJNUmAAPs2LLBsCnMVp17UoXURdualwlEz/YI4ECQkC4nlEMTTDMTwIIeJ8WuM81xI/SRM/Clue+b3DaJZKq0hQBaxrrISQyIuiiBBiGIYkSYahbcsmTkFFgdOwFTm/nBbydOzblCEiXbax0emqMGBNVWVZZlkWsCbVVFXVNMwP7z9OnKHVKImHw0wJrD89pe0YfdfVsYFNQ9e7EI+iKOAJJMtynY6+v3/w7OnzUukCkf9TnCZZkhr9Xtsx+64HXZmm2el0oFuKoqCaJv5y+HVr68X09DRBEAtzs0SSpvBniGcyZKiQcBA4rostC0jwlCQJXmEYbmfnba1aA6xcLt+9ef3Jo/vE/ucDiCoMBxM0jsPBAOLFGAuCACScVVXb3X23snIbsFKpVKvMb66vPbx3Z+lajXizvQ1wlo2GwxHw51uFseU4bhSd7O192tjYBAbISzMzayvLGw9Wbywt1ioL1YV5olKryrICfK/nGgZ2XQ+2PQjCep189fJ1uXwRsKmpqcUr1cfra6u3lsG5Mj83d3l28Wr1L+J9Wymlm0iMAAAAAElFTkSuQmCC","aspectRatio":1.5031847133757963,"src":"/static/c39f26c7cd303d0055c25d0f5a009b22/a1946/cover.png","srcSet":"/static/c39f26c7cd303d0055c25d0f5a009b22/5b37e/cover.png 236w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/49058/cover.png 472w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/a1946/cover.png 944w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/030f1/cover.png 1416w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/75927/cover.png 1888w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/14eb2/cover.png 2070w","srcWebp":"/static/c39f26c7cd303d0055c25d0f5a009b22/99fbb/cover.webp","srcSetWebp":"/static/c39f26c7cd303d0055c25d0f5a009b22/77392/cover.webp 236w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/1f177/cover.webp 472w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/99fbb/cover.webp 944w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/4a492/cover.webp 1416w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/b0b8f/cover.webp 1888w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/5c29c/cover.webp 2070w","sizes":"(max-width: 944px) 100vw, 944px"},"regular":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAACl0lEQVR42lWSy27TQBSGHdSglkVpmwSoKqigQCugErQseAJgUbEERJ+j4jkqVgheoBKr0nWRuKoiwXV8Gd/i2IntseNL7Li248RuOVHFgn9xNNLom//M+Q/h+/08z4uiSNM0juMkGUKNoigMQ9/3Xde1bLtn2WSL/YZ+a5qmttuiJDU4EsmIgKsgCIqJ8tFonKb/wY7j2JZlGZiU2UPm5xHbUFotTkCcyCqKTPieF/Qn5qAsy879B4MBvOh5nttzbBPbukkJNMkfN7gGjRiWZyVJlESRAMezszOo43wMcJIkJ6DoJAxCIE2s823xCDWO+WNOYASerVN1mqMFXqCbTSJNUmAAPs2LLBsCnMVp17UoXURdualwlEz/YI4ECQkC4nlEMTTDMTwIIeJ8WuM81xI/SRM/Clue+b3DaJZKq0hQBaxrrISQyIuiiBBiGIYkSYahbcsmTkFFgdOwFTm/nBbydOzblCEiXbax0emqMGBNVWVZZlkWsCbVVFXVNMwP7z9OnKHVKImHw0wJrD89pe0YfdfVsYFNQ9e7EI+iKOAJJMtynY6+v3/w7OnzUukCkf9TnCZZkhr9Xtsx+64HXZmm2el0oFuKoqCaJv5y+HVr68X09DRBEAtzs0SSpvBniGcyZKiQcBA4rostC0jwlCQJXmEYbmfnba1aA6xcLt+9ef3Jo/vE/ucDiCoMBxM0jsPBAOLFGAuCACScVVXb3X23snIbsFKpVKvMb66vPbx3Z+lajXizvQ1wlo2GwxHw51uFseU4bhSd7O192tjYBAbISzMzayvLGw9Wbywt1ioL1YV5olKryrICfK/nGgZ2XQ+2PQjCep189fJ1uXwRsKmpqcUr1cfra6u3lsG5Mj83d3l28Wr1L+J9Wymlm0iMAAAAAElFTkSuQmCC","aspectRatio":1.4954128440366972,"src":"/static/c39f26c7cd303d0055c25d0f5a009b22/3ddd4/cover.png","srcSet":"/static/c39f26c7cd303d0055c25d0f5a009b22/078a8/cover.png 163w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/e56da/cover.png 327w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/3ddd4/cover.png 653w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/c5cc7/cover.png 980w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/eebd2/cover.png 1306w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/14eb2/cover.png 2070w","srcWebp":"/static/c39f26c7cd303d0055c25d0f5a009b22/0acdf/cover.webp","srcSetWebp":"/static/c39f26c7cd303d0055c25d0f5a009b22/ac59e/cover.webp 163w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/7660b/cover.webp 327w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/0acdf/cover.webp 653w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/75470/cover.webp 980w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/68d47/cover.webp 1306w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/5c29c/cover.webp 2070w","sizes":"(max-width: 653px) 100vw, 653px"},"narrow":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAACl0lEQVR42lWSy27TQBSGHdSglkVpmwSoKqigQCugErQseAJgUbEERJ+j4jkqVgheoBKr0nWRuKoiwXV8Gd/i2IntseNL7Li248RuOVHFgn9xNNLom//M+Q/h+/08z4uiSNM0juMkGUKNoigMQ9/3Xde1bLtn2WSL/YZ+a5qmttuiJDU4EsmIgKsgCIqJ8tFonKb/wY7j2JZlGZiU2UPm5xHbUFotTkCcyCqKTPieF/Qn5qAsy879B4MBvOh5nttzbBPbukkJNMkfN7gGjRiWZyVJlESRAMezszOo43wMcJIkJ6DoJAxCIE2s823xCDWO+WNOYASerVN1mqMFXqCbTSJNUmAAPs2LLBsCnMVp17UoXURdualwlEz/YI4ECQkC4nlEMTTDMTwIIeJ8WuM81xI/SRM/Clue+b3DaJZKq0hQBaxrrISQyIuiiBBiGIYkSYahbcsmTkFFgdOwFTm/nBbydOzblCEiXbax0emqMGBNVWVZZlkWsCbVVFXVNMwP7z9OnKHVKImHw0wJrD89pe0YfdfVsYFNQ9e7EI+iKOAJJMtynY6+v3/w7OnzUukCkf9TnCZZkhr9Xtsx+64HXZmm2el0oFuKoqCaJv5y+HVr68X09DRBEAtzs0SSpvBniGcyZKiQcBA4rostC0jwlCQJXmEYbmfnba1aA6xcLt+9ef3Jo/vE/ucDiCoMBxM0jsPBAOLFGAuCACScVVXb3X23snIbsFKpVKvMb66vPbx3Z+lajXizvQ1wlo2GwxHw51uFseU4bhSd7O192tjYBAbISzMzayvLGw9Wbywt1ioL1YV5olKryrICfK/nGgZ2XQ+2PQjCep189fJ1uXwRsKmpqcUr1cfra6u3lsG5Mj83d3l28Wr1L+J9Wymlm0iMAAAAAElFTkSuQmCC","aspectRatio":1.5,"src":"/static/c39f26c7cd303d0055c25d0f5a009b22/502b1/cover.png","srcSet":"/static/c39f26c7cd303d0055c25d0f5a009b22/f2e6d/cover.png 114w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/4ddba/cover.png 229w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/502b1/cover.png 457w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/7ddc2/cover.png 686w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/435bf/cover.png 914w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/14eb2/cover.png 2070w","srcWebp":"/static/c39f26c7cd303d0055c25d0f5a009b22/15384/cover.webp","srcSetWebp":"/static/c39f26c7cd303d0055c25d0f5a009b22/31fce/cover.webp 114w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/e3e25/cover.webp 229w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/15384/cover.webp 457w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/0258d/cover.webp 686w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/64ea2/cover.webp 914w,\n/static/c39f26c7cd303d0055c25d0f5a009b22/5c29c/cover.webp 2070w","sizes":"(max-width: 457px) 100vw, 457px"},"seo":{"src":"/static/c39f26c7cd303d0055c25d0f5a009b22/6050d/cover.png"}}},"authors":[{"authorsPage":false,"bio":"I am a programmer living in Singapore. I blog about experiences navigating through my career as a Software Engineer.\n","id":"71f7934d-e1f7-5a1f-a9de-62ff48536726","name":"Sudaraka Jayathilaka","featured":true,"social":[{"url":"mailto:sudarakayasindu@gmail.com"},{"url":"https://github.com/sudaraka94"},{"url":"https://www.linkedin.com/in/sudarakajayathilaka"},{"url":"https://twitter.com/Sudaraka94"},{"url":"https://medium.com/@sudarakayasindu"}],"slug":"/authors/sudaraka-jayathilaka","avatar":{"small":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAQF/8QAFwEAAwEAAAAAAAAAAAAAAAAAAQIEBf/aAAwDAQACEAMQAAABrkqzki1QJ8KYfT1QsX//xAAaEAEBAAMBAQAAAAAAAAAAAAABAgADEwQS/9oACAEBAAEFArr5md1dctCZZndm9XarWeZef//EABkRAAIDAQAAAAAAAAAAAAAAAAECAAMyEP/aAAgBAwEBPwGtAUJ4uRLNGf/EABYRAQEBAAAAAAAAAAAAAAAAAAEAEP/aAAgBAgEBPwE1v//EAB0QAAEEAgMAAAAAAAAAAAAAAAABAhAREiEiMYH/2gAIAQEABj8CVTF7auNnLUOLXs9P/8QAGxAAAgMBAQEAAAAAAAAAAAAAAREAITFBEIH/2gAIAQEAAT8ho1rkVDcF4fEx9gaACYUoLFRpHChL3eI9DyP/2gAMAwEAAgADAAAAEAwHvv/EABgRAQEAAwAAAAAAAAAAAAAAAAEAECGh/9oACAEDAQE/EEwbxyECv//EABgRAAMBAQAAAAAAAAAAAAAAAAABMRAR/9oACAECAQE/EEXMUKP/xAAdEAEAAgMAAwEAAAAAAAAAAAABESEAMUEQYZGx/9oACAEBAAE/ELtMUOug+5Hd1bmH34P3IkLS8ruPOIkcCEXHLxAKEdJn4uUYsvbbVGTlIUJ4QZ//2Q==","aspectRatio":1,"src":"/static/c9b36270340739981770def5a8f2164f/fa1ea/sudaraka-jayathilaka.jpg","srcSet":"/static/c9b36270340739981770def5a8f2164f/afb2b/sudaraka-jayathilaka.jpg 13w,\n/static/c9b36270340739981770def5a8f2164f/7c20e/sudaraka-jayathilaka.jpg 25w,\n/static/c9b36270340739981770def5a8f2164f/fa1ea/sudaraka-jayathilaka.jpg 50w,\n/static/c9b36270340739981770def5a8f2164f/03612/sudaraka-jayathilaka.jpg 75w,\n/static/c9b36270340739981770def5a8f2164f/61cdf/sudaraka-jayathilaka.jpg 100w,\n/static/c9b36270340739981770def5a8f2164f/1920d/sudaraka-jayathilaka.jpg 1080w","srcWebp":"/static/c9b36270340739981770def5a8f2164f/e7b2c/sudaraka-jayathilaka.webp","srcSetWebp":"/static/c9b36270340739981770def5a8f2164f/58718/sudaraka-jayathilaka.webp 13w,\n/static/c9b36270340739981770def5a8f2164f/74aad/sudaraka-jayathilaka.webp 25w,\n/static/c9b36270340739981770def5a8f2164f/e7b2c/sudaraka-jayathilaka.webp 50w,\n/static/c9b36270340739981770def5a8f2164f/ed320/sudaraka-jayathilaka.webp 75w,\n/static/c9b36270340739981770def5a8f2164f/66016/sudaraka-jayathilaka.webp 100w,\n/static/c9b36270340739981770def5a8f2164f/4c77b/sudaraka-jayathilaka.webp 1080w","sizes":"(max-width: 50px) 100vw, 50px"},"medium":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAQF/8QAFwEAAwEAAAAAAAAAAAAAAAAAAQIEBf/aAAwDAQACEAMQAAABrkqzki1QJ8KYfT1QsX//xAAaEAEBAAMBAQAAAAAAAAAAAAABAgADEwQS/9oACAEBAAEFArr5md1dctCZZndm9XarWeZef//EABkRAAIDAQAAAAAAAAAAAAAAAAECAAMyEP/aAAgBAwEBPwGtAUJ4uRLNGf/EABYRAQEBAAAAAAAAAAAAAAAAAAEAEP/aAAgBAgEBPwE1v//EAB0QAAEEAgMAAAAAAAAAAAAAAAABAhAREiEiMYH/2gAIAQEABj8CVTF7auNnLUOLXs9P/8QAGxAAAgMBAQEAAAAAAAAAAAAAAREAITFBEIH/2gAIAQEAAT8ho1rkVDcF4fEx9gaACYUoLFRpHChL3eI9DyP/2gAMAwEAAgADAAAAEAwHvv/EABgRAQEAAwAAAAAAAAAAAAAAAAEAECGh/9oACAEDAQE/EEwbxyECv//EABgRAAMBAQAAAAAAAAAAAAAAAAABMRAR/9oACAECAQE/EEXMUKP/xAAdEAEAAgMAAwEAAAAAAAAAAAABESEAMUEQYZGx/9oACAEBAAE/ELtMUOug+5Hd1bmH34P3IkLS8ruPOIkcCEXHLxAKEdJn4uUYsvbbVGTlIUJ4QZ//2Q==","aspectRatio":1,"src":"/static/c9b36270340739981770def5a8f2164f/61cdf/sudaraka-jayathilaka.jpg","srcSet":"/static/c9b36270340739981770def5a8f2164f/7c20e/sudaraka-jayathilaka.jpg 25w,\n/static/c9b36270340739981770def5a8f2164f/fa1ea/sudaraka-jayathilaka.jpg 50w,\n/static/c9b36270340739981770def5a8f2164f/61cdf/sudaraka-jayathilaka.jpg 100w,\n/static/c9b36270340739981770def5a8f2164f/59538/sudaraka-jayathilaka.jpg 150w,\n/static/c9b36270340739981770def5a8f2164f/fd013/sudaraka-jayathilaka.jpg 200w,\n/static/c9b36270340739981770def5a8f2164f/1920d/sudaraka-jayathilaka.jpg 1080w","srcWebp":"/static/c9b36270340739981770def5a8f2164f/66016/sudaraka-jayathilaka.webp","srcSetWebp":"/static/c9b36270340739981770def5a8f2164f/74aad/sudaraka-jayathilaka.webp 25w,\n/static/c9b36270340739981770def5a8f2164f/e7b2c/sudaraka-jayathilaka.webp 50w,\n/static/c9b36270340739981770def5a8f2164f/66016/sudaraka-jayathilaka.webp 100w,\n/static/c9b36270340739981770def5a8f2164f/d9b14/sudaraka-jayathilaka.webp 150w,\n/static/c9b36270340739981770def5a8f2164f/6b183/sudaraka-jayathilaka.webp 200w,\n/static/c9b36270340739981770def5a8f2164f/4c77b/sudaraka-jayathilaka.webp 1080w","sizes":"(max-width: 100px) 100vw, 100px"},"large":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAQF/8QAFwEAAwEAAAAAAAAAAAAAAAAAAQIEBf/aAAwDAQACEAMQAAABrkqzki1QJ8KYfT1QsX//xAAaEAEBAAMBAQAAAAAAAAAAAAABAgADEwQS/9oACAEBAAEFArr5md1dctCZZndm9XarWeZef//EABkRAAIDAQAAAAAAAAAAAAAAAAECAAMyEP/aAAgBAwEBPwGtAUJ4uRLNGf/EABYRAQEBAAAAAAAAAAAAAAAAAAEAEP/aAAgBAgEBPwE1v//EAB0QAAEEAgMAAAAAAAAAAAAAAAABAhAREiEiMYH/2gAIAQEABj8CVTF7auNnLUOLXs9P/8QAGxAAAgMBAQEAAAAAAAAAAAAAAREAITFBEIH/2gAIAQEAAT8ho1rkVDcF4fEx9gaACYUoLFRpHChL3eI9DyP/2gAMAwEAAgADAAAAEAwHvv/EABgRAQEAAwAAAAAAAAAAAAAAAAEAECGh/9oACAEDAQE/EEwbxyECv//EABgRAAMBAQAAAAAAAAAAAAAAAAABMRAR/9oACAECAQE/EEXMUKP/xAAdEAEAAgMAAwEAAAAAAAAAAAABESEAMUEQYZGx/9oACAEBAAE/ELtMUOug+5Hd1bmH34P3IkLS8ruPOIkcCEXHLxAKEdJn4uUYsvbbVGTlIUJ4QZ//2Q==","aspectRatio":1,"src":"/static/c9b36270340739981770def5a8f2164f/ec46e/sudaraka-jayathilaka.jpg","srcSet":"/static/c9b36270340739981770def5a8f2164f/a2637/sudaraka-jayathilaka.jpg 82w,\n/static/c9b36270340739981770def5a8f2164f/15203/sudaraka-jayathilaka.jpg 164w,\n/static/c9b36270340739981770def5a8f2164f/ec46e/sudaraka-jayathilaka.jpg 328w,\n/static/c9b36270340739981770def5a8f2164f/b69a5/sudaraka-jayathilaka.jpg 492w,\n/static/c9b36270340739981770def5a8f2164f/23a36/sudaraka-jayathilaka.jpg 656w,\n/static/c9b36270340739981770def5a8f2164f/1920d/sudaraka-jayathilaka.jpg 1080w","srcWebp":"/static/c9b36270340739981770def5a8f2164f/5a48e/sudaraka-jayathilaka.webp","srcSetWebp":"/static/c9b36270340739981770def5a8f2164f/2d087/sudaraka-jayathilaka.webp 82w,\n/static/c9b36270340739981770def5a8f2164f/29d87/sudaraka-jayathilaka.webp 164w,\n/static/c9b36270340739981770def5a8f2164f/5a48e/sudaraka-jayathilaka.webp 328w,\n/static/c9b36270340739981770def5a8f2164f/42f2e/sudaraka-jayathilaka.webp 492w,\n/static/c9b36270340739981770def5a8f2164f/dec03/sudaraka-jayathilaka.webp 656w,\n/static/c9b36270340739981770def5a8f2164f/4c77b/sudaraka-jayathilaka.webp 1080w","sizes":"(max-width: 328px) 100vw, 328px"}}}],"basePath":"/","permalink":"https://sudaraka94.com/tackling-high-cardinality-tags-in-metrics/","slug":"/tackling-high-cardinality-tags-in-metrics","id":"955710d7-6ce2-5155-98dc-2afb76a71416","title":"Tackling High Cardinality Tags in Metrics","canonicalUrl":null,"mailchimp":"","next":[{"id":"58eb082e-6900-508f-8f00-1fefcf4a5b49","slug":"/kafka-rebalancing-kafka-lag-and-deployments","secret":false,"title":"Kafka Rebalancing, Kafka lag and Deployments","author":"Sudaraka Jayathilaka","date":"October 13th, 2024","dateForSEO":"2024-10-13T00:00:00.000Z","timeToRead":"3 min read","excerpt":"I have been working with Kafka for a while now. I wanted to blog about some of the common failure patterns I have seen in associated with…","canonical_url":null,"subscription":true,"content_file_path":"/home/runner/work/sudaraka94.github.io/sudaraka94.github.io/content/posts/2024-10-13-high-kafka-lag-during-deployments/index.mdx","body":"\nI have been working with Kafka for a while now. I wanted to blog about some of the common failure patterns\nI have seen in associated with Kafka Rebalancing, Kafka lag and Deployments.\n\n## Context\n\n### Kafka Consumer Rebalancing\n\nKafka has this concept of Consumer Groups. Each consumer group can independently consume messages\nfrom a given Kafka topic. Each Kafka partition is consumed by a single Kafka consumer within a\nconsumer group. This behavior is very vital when providing processing order guarantees during event\nconsumption. But that's a story for another day. Anyway, Kafka would make sure that all the partitions\nare being assigned to a Kafka consumer.\n\nBut what happens when one or more than one Kafka consumer goes down or a new consumer joins the group?\n\nThat's when the Kafka brokers trigger a process called Kafka Consumer Rebalancing. This process\nredistributes the partitions among the consumers of the consumer group. But, this process causes a \nstop the world effect on message consumption. During the process, non of the consumers are not able\nto consume any message. \n\n### Kafka Lag\n\nDuring Kafka consumer rebalances the stop the world effect could cause unconsumed kafka messages \nto get piled up in the topic. The term **Kafka Consumer Lag** refers to the delta between \nthe production and consumption of Kafka messages.\n\n## Consumers getting overwhelmed due to high Kafka lag\n\nWhen Kafka lag is high, Kafka consumers try to consume all the messages piled up in the topic\nvery fast. This could cause the kafka consumers to hit the resource limits and get restarted \nor killed (eg: if the consumer runs on Kubernetes). During very high loads, this effect can cause\nmassive service disruptions. \n\n### The Backpressure\n\nThe best way to fix this is implementing back preassure on Kafka consumers.\n\nThe term backpressure refers to the ability to control the flow of incoming data. In the context of\nKafka Consumers, that means the ability of the Kafka consumer to control the rate of processing \nincoming kafka messages. This gives the kafka consumer the ability to consume messages in a constant \nrate even if there is a very high kafka lag.\n\n### Discarding older events\n\nAnother approach would be to discard messages that exceed a specified age threshold. This is\na highly contextual way to battle the kafka lag and wouldn't be suitable for some scenarios. \nIn certain cases, it might be meaningful to only consider events occured in past few minutes \n(in real time systems). In such cases, we can add a simple condition to simply discard the\nolder events which aren't really worth processing.\n\n## Kafka consumers and Kubernetes rolling deployments\n\nKubernetes rolling deployments is a way of doing deployments within kubernetes. It will gradually replace the\nolder pods with the newer version pods. But rolling deployments might not be ideal for the kafka consumers.\n\nDuring rolling deployments, Kubernetes gradually spawns new pods while simultaneously terminating older ones. \nHowever, when considering a single Kafka consumer group, the addition of each new Kafka consumer can trigger \nrebalances, as can the removal of old consumers. This process can lead to multiple rebalances, resulting in \nseveral interruptions to Kafka message consumption.\n\n### Batch Deployments\n\nOne of the ways to mitigate this is doing batchwise deployments. Since most of the kafka consumers joins\nthe group during the same time it can drastically reduce the number of triggered rebalances.\n","hero":{"full":{"base64":"data:image/webp;base64,UklGRkwAAABXRUJQVlA4IEAAAABQAwCdASoUAAsAPtFUpEuoJKOhsAgBABoJaQAD4loN/GBmIAD+9hCpbXz51bD36QrgssaRe+nANC25iSIHMoAA","aspectRatio":1.903225806451613,"src":"/static/d5969fd208eeb2cd74f6891e69cca1fb/99fbb/hero.webp","srcSet":"/static/d5969fd208eeb2cd74f6891e69cca1fb/77392/hero.webp 236w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/1f177/hero.webp 472w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/99fbb/hero.webp 944w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/4a492/hero.webp 1416w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/b0b8f/hero.webp 1888w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/ba1bc/hero.webp 1960w","srcWebp":"/static/d5969fd208eeb2cd74f6891e69cca1fb/99fbb/hero.webp","srcSetWebp":"/static/d5969fd208eeb2cd74f6891e69cca1fb/77392/hero.webp 236w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/1f177/hero.webp 472w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/99fbb/hero.webp 944w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/4a492/hero.webp 1416w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/b0b8f/hero.webp 1888w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/ba1bc/hero.webp 1960w","sizes":"(max-width: 944px) 100vw, 944px"},"regular":{"base64":"data:image/webp;base64,UklGRkwAAABXRUJQVlA4IEAAAAAwAwCdASoUAAoAPtFUo0uoJKMhsAgBABoJaQAAW+vTPeYAAP72EotV4j9mNRKsiszt4++QmsQ24O525xphv6AA","aspectRatio":1.9176470588235295,"src":"/static/d5969fd208eeb2cd74f6891e69cca1fb/0acdf/hero.webp","srcSet":"/static/d5969fd208eeb2cd74f6891e69cca1fb/ac59e/hero.webp 163w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/7660b/hero.webp 327w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/0acdf/hero.webp 653w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/75470/hero.webp 980w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/68d47/hero.webp 1306w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/ba1bc/hero.webp 1960w","srcWebp":"/static/d5969fd208eeb2cd74f6891e69cca1fb/0acdf/hero.webp","srcSetWebp":"/static/d5969fd208eeb2cd74f6891e69cca1fb/ac59e/hero.webp 163w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/7660b/hero.webp 327w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/0acdf/hero.webp 653w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/75470/hero.webp 980w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/68d47/hero.webp 1306w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/ba1bc/hero.webp 1960w","sizes":"(max-width: 653px) 100vw, 653px"},"narrow":{"base64":"data:image/webp;base64,UklGRkwAAABXRUJQVlA4IEAAAABQAwCdASoUAAsAPtFUpEuoJKOhsAgBABoJaQAD4loN/GBmIAD+9hCpbXz51bD36QrgssaRe+nANC25iSIHMoAA","aspectRatio":1.9,"src":"/static/d5969fd208eeb2cd74f6891e69cca1fb/15384/hero.webp","srcSet":"/static/d5969fd208eeb2cd74f6891e69cca1fb/31fce/hero.webp 114w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/e3e25/hero.webp 229w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/15384/hero.webp 457w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/0258d/hero.webp 686w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/64ea2/hero.webp 914w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/ba1bc/hero.webp 1960w","srcWebp":"/static/d5969fd208eeb2cd74f6891e69cca1fb/15384/hero.webp","srcSetWebp":"/static/d5969fd208eeb2cd74f6891e69cca1fb/31fce/hero.webp 114w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/e3e25/hero.webp 229w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/15384/hero.webp 457w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/0258d/hero.webp 686w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/64ea2/hero.webp 914w,\n/static/d5969fd208eeb2cd74f6891e69cca1fb/ba1bc/hero.webp 1960w","sizes":"(max-width: 457px) 100vw, 457px"},"seo":{"src":"/static/d5969fd208eeb2cd74f6891e69cca1fb/9000d/hero.webp"}}},{"id":"92dcd383-ad51-5cd8-bd43-a2fe2003deb5","slug":"/coding-a-neural-network-from-scratch","secret":false,"title":"Coding a neural network from scratch","author":"Sudaraka Jayathilaka","date":"June 6th, 2024","dateForSEO":"2024-06-06T00:00:00.000Z","timeToRead":"2 min read","excerpt":"Learning how AI works on a deeper level has always been in my bucket list. I found this amazing video by Andrej Karpathy which walks you…","canonical_url":null,"subscription":true,"content_file_path":"/home/runner/work/sudaraka94.github.io/sudaraka94.github.io/content/posts/2024-06-06-neural-network-from-scratch/index.mdx","body":"\nLearning how AI works on a deeper level has always been in my bucket list. I found this amazing video by [Andrej Karpathy](https://x.com/karpathy)\nwhich walks you through the process of creating an autograd engine first and then move on to create a very basic Neural Network. So here is my\nexperience following the video.\n\n[](https://youtu.be/VMj-3S1tku0?list=PLAqhIrjkxbuWI23v9cThsA9GvCAUhRvKZ)\n\n## Autograd Engine\n\n![](./images/nn.png)\n[image source](https://cs231n.github.io/neural-networks-1/)\n\nA Neural Network is basically a graph. once we give an input, the neural network returns an output. Each of these neurons have certain parameters\nwhich impacts the output directly. We train neural networks to output a desired value by tweaking these parameters in neurons. But how can we derive\nthe parameter values that could cause the neural network to output the desired value?. \n\nTurns out, old friend calculus comes to help here. We can approximate the impact of a certain parameter on the output of the Neural Network, by\ncalculating the gradient of the parameter with respect to the output. \n\nAutograd engine helps us to build a Neural Network (modeled as a graph), and easily do backpropagation to calculate the gradients of each parameter.\nHence the name Autograd Engine. \n\n## Tiny Grad\n\n[](https://github.com/sudaraka94/tinygrad)\n\nTiny grad is the engine I build. This is a very basic Auto Grad engine which\n- Supports implementing Simple Neural networks\n- Only works with scalaer inputs\n- Supports backpropagating through the neural network and calculating gradient values for each parameter\n\nI did a tiny experiment with tinygrad, where I created a simple neural netowrk and trained it to predict a given\ninput. I was simply playing with a set of numbers, but it was quite fun. You can find my jupyter notebook below,\n\n[](https://github.com/sudaraka94/tinygrad/blob/main/tinygrad.ipynb)\n\n## Micrograd\n\nThe tinygrad engine is mostly inspired by Andrej Karpathi's Micrograd, Autograd Engine.\n\n[](https://github.com/karpathy/micrograd)\n\n\n[article banner source](https://miro.medium.com/v2/resize:fit:700/0*AONVmd3v4wO_dWr6)\n","hero":{"full":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAABaUlEQVR42lVRC2+CMBjk//+kLZubzC1TBAqCiCArII8KAvIoRVqGsi3ZpUnT5u77LnfccAdjA5tuNmRlTdntVeG2bMlEyOqmu/bDf3DszrsQhs4X3NTolBh+7AZhliaWH27dIEEjYt2PUZqRth3n9pRNe7j7wuGMmayb+52x0XTVjQVJ1lRF2pqSBRUgg/HAwIJu4Hu7A4zyejLL5Xl+JW3SUEnf8/PXkWii/P1zNZ89A9NW4XH8XCzetCA5uJ4iS58iQBc8aoui4DDG/bVLGwoMa8HPZaDYKP9Yrp4eH1TT1t3w9WXG87wxiqG3FlZLEZxK3BGSpumP7bxlYLt3bEvVNOOIVqIkrQVlZ20cTxQEUVxvfWQ5EDqHnf11ujQ/tqfcCkKTosrOaRBGihc7rpclJwMeFeeI4igMQwCjKDmXRYFb0vW/gf1VdeumqnpKq+stzyLPatJhOmDclGXZ9MMoIaSllP5V9Q22pre6z80tBAAAAABJRU5ErkJggg==","aspectRatio":2.5376344086021505,"src":"/static/cb1f1de4a0856be5607cd1df9cb36791/05b00/hero.png","srcSet":"/static/cb1f1de4a0856be5607cd1df9cb36791/5b37e/hero.png 236w,\n/static/cb1f1de4a0856be5607cd1df9cb36791/49058/hero.png 472w,\n/static/cb1f1de4a0856be5607cd1df9cb36791/05b00/hero.png 700w","srcWebp":"/static/cb1f1de4a0856be5607cd1df9cb36791/64998/hero.webp","srcSetWebp":"/static/cb1f1de4a0856be5607cd1df9cb36791/77392/hero.webp 236w,\n/static/cb1f1de4a0856be5607cd1df9cb36791/1f177/hero.webp 472w,\n/static/cb1f1de4a0856be5607cd1df9cb36791/64998/hero.webp 700w","sizes":"(max-width: 700px) 100vw, 700px"},"regular":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAABaUlEQVR42lVRC2+CMBjk//+kLZubzC1TBAqCiCArII8KAvIoRVqGsi3ZpUnT5u77LnfccAdjA5tuNmRlTdntVeG2bMlEyOqmu/bDf3DszrsQhs4X3NTolBh+7AZhliaWH27dIEEjYt2PUZqRth3n9pRNe7j7wuGMmayb+52x0XTVjQVJ1lRF2pqSBRUgg/HAwIJu4Hu7A4zyejLL5Xl+JW3SUEnf8/PXkWii/P1zNZ89A9NW4XH8XCzetCA5uJ4iS58iQBc8aoui4DDG/bVLGwoMa8HPZaDYKP9Yrp4eH1TT1t3w9WXG87wxiqG3FlZLEZxK3BGSpumP7bxlYLt3bEvVNOOIVqIkrQVlZ20cTxQEUVxvfWQ5EDqHnf11ujQ/tqfcCkKTosrOaRBGihc7rpclJwMeFeeI4igMQwCjKDmXRYFb0vW/gf1VdeumqnpKq+stzyLPatJhOmDclGXZ9MMoIaSllP5V9Q22pre6z80tBAAAAABJRU5ErkJggg==","aspectRatio":2.546875,"src":"/static/cb1f1de4a0856be5607cd1df9cb36791/3ddd4/hero.png","srcSet":"/static/cb1f1de4a0856be5607cd1df9cb36791/078a8/hero.png 163w,\n/static/cb1f1de4a0856be5607cd1df9cb36791/e56da/hero.png 327w,\n/static/cb1f1de4a0856be5607cd1df9cb36791/3ddd4/hero.png 653w,\n/static/cb1f1de4a0856be5607cd1df9cb36791/05b00/hero.png 700w","srcWebp":"/static/cb1f1de4a0856be5607cd1df9cb36791/0acdf/hero.webp","srcSetWebp":"/static/cb1f1de4a0856be5607cd1df9cb36791/ac59e/hero.webp 163w,\n/static/cb1f1de4a0856be5607cd1df9cb36791/7660b/hero.webp 327w,\n/static/cb1f1de4a0856be5607cd1df9cb36791/0acdf/hero.webp 653w,\n/static/cb1f1de4a0856be5607cd1df9cb36791/64998/hero.webp 700w","sizes":"(max-width: 653px) 100vw, 653px"},"narrow":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAABaUlEQVR42lVRC2+CMBjk//+kLZubzC1TBAqCiCArII8KAvIoRVqGsi3ZpUnT5u77LnfccAdjA5tuNmRlTdntVeG2bMlEyOqmu/bDf3DszrsQhs4X3NTolBh+7AZhliaWH27dIEEjYt2PUZqRth3n9pRNe7j7wuGMmayb+52x0XTVjQVJ1lRF2pqSBRUgg/HAwIJu4Hu7A4zyejLL5Xl+JW3SUEnf8/PXkWii/P1zNZ89A9NW4XH8XCzetCA5uJ4iS58iQBc8aoui4DDG/bVLGwoMa8HPZaDYKP9Yrp4eH1TT1t3w9WXG87wxiqG3FlZLEZxK3BGSpumP7bxlYLt3bEvVNOOIVqIkrQVlZ20cTxQEUVxvfWQ5EDqHnf11ujQ/tqfcCkKTosrOaRBGihc7rpclJwMeFeeI4igMQwCjKDmXRYFb0vW/gf1VdeumqnpKq+stzyLPatJhOmDclGXZ9MMoIaSllP5V9Q22pre6z80tBAAAAABJRU5ErkJggg==","aspectRatio":2.533333333333333,"src":"/static/cb1f1de4a0856be5607cd1df9cb36791/502b1/hero.png","srcSet":"/static/cb1f1de4a0856be5607cd1df9cb36791/f2e6d/hero.png 114w,\n/static/cb1f1de4a0856be5607cd1df9cb36791/4ddba/hero.png 229w,\n/static/cb1f1de4a0856be5607cd1df9cb36791/502b1/hero.png 457w,\n/static/cb1f1de4a0856be5607cd1df9cb36791/7ddc2/hero.png 686w,\n/static/cb1f1de4a0856be5607cd1df9cb36791/05b00/hero.png 700w","srcWebp":"/static/cb1f1de4a0856be5607cd1df9cb36791/15384/hero.webp","srcSetWebp":"/static/cb1f1de4a0856be5607cd1df9cb36791/31fce/hero.webp 114w,\n/static/cb1f1de4a0856be5607cd1df9cb36791/e3e25/hero.webp 229w,\n/static/cb1f1de4a0856be5607cd1df9cb36791/15384/hero.webp 457w,\n/static/cb1f1de4a0856be5607cd1df9cb36791/0258d/hero.webp 686w,\n/static/cb1f1de4a0856be5607cd1df9cb36791/64998/hero.webp 700w","sizes":"(max-width: 457px) 100vw, 457px"},"seo":{"src":"/static/cb1f1de4a0856be5607cd1df9cb36791/05b00/hero.png"}}}],"frontmatter":{"title":"Tackling High Cardinality Tags in Metrics","author":"Sudaraka Jayathilaka","date":"2024-12-22T00:00:00.000Z","hero":"./images/cover.png","excerpt":"I wanted to share how I tackled the problem of high cardinality tags in a certain metric"}}},"staticQueryHashes":["1140881942","1921650733","2068910035","2444214635","2744905544","366415130"],"slicesMap":{}}