"use strict";(self.webpackChunknovela_blog=self.webpackChunknovela_blog||[]).push([[382],{940:function(e,t,n){n.r(t),n.d(t,{default:function(){return H}});var a=n(5276),i=n(3942),o=n(8453),r=n(6540);function c(e){const t=Object.assign({p:"p",h2:"h2",a:"a",code:"code",ul:"ul",li:"li"},(0,o.R)(),e.components);return r.createElement(r.Fragment,null,r.createElement(t.p,null,"I wanted to share how I tackled the problem of high cardinality tags in a certain metric. But first, let me give some context around the topic of Metrics and Metric tags."),"\n",r.createElement(t.h2,null,"Metrics"),"\n",r.createElement(t.p,null,"Metrics are a vital part of any software system. You can find many mature Specifications in different technology domains standardizing the usage of metrics. ",r.createElement(t.a,{href:"https://microprofile.io/specifications/metrics",target:"_blank",rel:"noreferrer"},"Microprofile Metrics Specification"),",\nis one of my favourites. But introducing a metric to a system isn’t always a straightforward decision, We always need to figure out what works best for the use case. This comes down to the questions such as,\nIs it A counter? A gauge? or some other type of metric?\nWhat are the metadata we want to include as tags in the metric?\nHow is it going to be visualized?\nWill there be any monitors set up on the metric?"),"\n",r.createElement(t.h2,null,"Metric Tags"),"\n",r.createElement(t.p,null,"One of the main aspects of a metric is tags. Metric tags give us a lot of agility in visualizing and analyzing certain metrics. Let’s take a hypothetical example.\nYou have an API service that allows users to make event ticket purchases. Now you want to monitor the purchases happening through the API and track the aspects such as,\nNumber of purchases by each account per minute\nCountry of origin for each purchase\nWhether each purchase was successful or failed\nServer id, which served the specific purchase"),"\n",r.createElement(t.p,null,"To obtain these types of insights, we can simply tag the metric with the relevant information.\nTag the metric with, ",r.createElement(t.code,null,"country: us")," to group purchase metrics with the country.\nTag the metric with, ",r.createElement(t.code,null,"success: true")," or ",r.createElement(t.code,null,"success: false")," depending on the status of the call. This might help track the failure rate of the calls made to the API."),"\n",r.createElement(t.h2,null,"Collecting and Visualizing Metrics"),"\n",r.createElement(t.p,null,"For collecting and visualizing metrics, you have two options\nYou can use a self-hosted solution like Prometheus.\nYou can use a platform like DataDog/NewRelic.\nI don’t want to bore you with the details about the pros and cons of both. But the problem I’m talking about is mostly related to the second option."),"\n",r.createElement(t.p,null,"When using third-party services like DataDog, they do have a pricing strategy that accounts for the cardinality of the tags added for the metrics. For example, ",r.createElement(t.a,{href:"https://docs.datadoghq.com/account_management/billing/custom_metrics/?tab=countrate#when-are-you-charged-for-ingested-vs-indexed-custom-metrics",target:"_blank",rel:"noreferrer"},"this Datadog documentation")," explains\nhow tags and the cardinality of tags cause a single metric to be reported as multiple custom metrics in DataDog."),"\n",r.createElement(t.p,null,"TLDR; When you have metrics with exponentially high cardinality, you have to pay so much more."),"\n",r.createElement(t.h2,null,"How Can we tackle this problem efficiently?"),"\n",r.createElement(t.p,null,"Let’s take the previous hypothetical scenario. I gave a few examples of tags we can add to the metric. One of them was adding the accountId (or any other account identifier) to the metric for tracking the rate of purchases in the scope of an account. But unlike adding the country as a tag (there is only a finite amount of countries in the world), adding the accountId can be super expensive due to the sheer number of accounts that can be created within the system. Cost isn’t the only problem here. Having a tag with so many values might not provide really meaningful insights as well.\nOne of the solutions is to use a histogram metric for tracking the rate of purchases. The histogram aggregates the reported values into different buckets. Consider following values"),"\n",r.createElement(t.ul,null,"\n",r.createElement(t.li,null,"Account A -> 1 purchases per minute"),"\n",r.createElement(t.li,null,"Account B -> 1000 purchases per minute"),"\n",r.createElement(t.li,null,"Account C -> 1001 purchases per minute"),"\n"),"\n",r.createElement(t.p,null,"Instead of tagging the metric with the accountId, the distribution of purchases per minute can be divided into buckets by the number of purchases made within the time window. According to the example,"),"\n",r.createElement(t.ul,null,"\n",r.createElement(t.li,null,r.createElement(t.code,null,"0 <= n < 100"),": [Account A]"),"\n",r.createElement(t.li,null,r.createElement(t.code,null,"1000 <= n < 1100"),": [Account B, Account C]"),"\n"),"\n",r.createElement(t.p,null,"This way, we can essentially eliminate the high cardinality tags and obtain meaningful insights from the metrics such as,\nHow many accounts are there with above 1000 purchases per minute?\nIf we were to rate limit the API for too many purchase requests, what would be the limit value?"),"\n",r.createElement(t.h2,null,"Conclusion"),"\n",r.createElement(t.p,null,"It’s always critical to think about the cost when adding metrics. High cardinality tags can be the cause of unexpectedly high invoices from observability vendors like NewRelic and Datadog. If this is happening, it’s always worth backtracking from what you really want to measure to what kind of metric you need to use."))}var l,s,h,u,m,d,p,g,f=function(e){void 0===e&&(e={});const{wrapper:t}=Object.assign({},(0,o.R)(),e.components);return t?r.createElement(t,e,r.createElement(c,e)):c(e)},w=n(7350),y=n.n(w),b=n(4794),E=n(1589),A=n(2267),v=n(1110),k=n(5922),x=n(8729),I=n(396),C=n(1601),M=n(6574),z=n(9618),D=n(8947),T=n(9818),S=n(7507),j=n(958);const B=e=>{let{pageContext:t,location:n,children:a}=e;const i=(0,r.useRef)(null),{0:o,1:c}=(0,r.useState)(!1),{0:l,1:s}=(0,r.useState)(0),h=(0,b.useStaticQuery)("1921650733").allSite.edges[0].node.siteMetadata.name,{article:u,authors:m,next:d}=t;return(0,r.useEffect)((()=>{const e=y()((()=>{const t=i.current;if(t){if(!o){const n=(0,I.sg)(e);t.querySelectorAll("img").forEach((e=>{e.complete||(e.onload=n)})),c(!0)}s(t.getBoundingClientRect().height)}}),20);return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)}),[]),r.createElement(E.A,null,r.createElement(T.A,{article:u,authors:m,location:n}),r.createElement(M.A,{article:u,authors:m}),r.createElement(C.A,{contentHeight:l},r.createElement(v.A,{contentHeight:l})),r.createElement(R,null,r.createElement(z.A)),r.createElement(_,{ref:i},r.createElement(A.A,null,r.createElement(S.A),a)),r.createElement(j.A,{pageContext:t}),d.length>0&&r.createElement(W,{narrow:!0},r.createElement(q,null,"More articles from ",h),r.createElement(D.A,{articles:d}),r.createElement(L)))};function H(e){return r.createElement(B,e,r.createElement(f,e))}const R=(0,i.A)("div",{target:"e1rojouh4"})("position:relative;padding-top:60px;transition:background 0.2s linear;text-align:center;",x.A.tablet_up(l||(l=(0,a.A)(["\n    display: none;\n  "]))),";"),_=(0,i.A)("article",{target:"e1rojouh3"})("position:relative;padding:160px 0 35px;padding-left:68px;transition:background 0.2s linear;",x.A.desktop(s||(s=(0,a.A)(["\n    padding-left: 53px;\n  "])))," ",x.A.tablet(h||(h=(0,a.A)(["\n    padding: 70px 0 80px;\n  "])))," ",x.A.phablet(u||(u=(0,a.A)(["\n    padding: 60px 0;\n  "]))),";"),W=(0,i.A)(k.A,{target:"e1rojouh2"})({name:"4zleql",styles:"display:block"}),q=(0,i.A)("h3",{target:"e1rojouh1"})("position:relative;opacity:0.25;margin-bottom:100px;font-weight:400;color:",(e=>e.theme.colors.primary),";",x.A.tablet(m||(m=(0,a.A)(["\n    margin-bottom: 60px;\n  "])))," &::after{content:'';position:absolute;background:",(e=>e.theme.colors.grey),";width:",810/1140*100,"%;height:1px;right:0;top:11px;",x.A.tablet(d||(d=(0,a.A)(["\n      width: ","%;\n    "])),600/1140*100)," ",x.A.phablet(p||(p=(0,a.A)(["\n      width: ","%;\n    "])),400/1140*100)," ",x.A.phone(g||(g=(0,a.A)(["\n      width: 90px\n    "]))),";}"),L=(0,i.A)("div",{target:"e1rojouh0"})({name:"n4muu5",styles:"margin-bottom:65px"})}}]);
//# sourceMappingURL=component---node-modules-sudaraka-94-gatsby-theme-novela-src-templates-article-template-tsx-content-file-path-content-posts-2024-12-22-high-cardinality-tags-in-metrics-index-mdx-c0aaee30af3ad1aff02d.js.map